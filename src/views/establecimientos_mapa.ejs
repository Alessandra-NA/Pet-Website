<div>
  <div class="invisible" id="btnAgregar" data-bs-toggle="modal" data-bs-target="#modalAgregar">Agregar</div>
</div>
<h3>Lugares pet friendly</h3>
<div class="row">
  <div id="map" class="col-12 col-lg-8"></div>
  <div class="col-12 col-lg-4">
    <% establecimientos.forEach(function(establecimiento){ %>
    
    <div class="border border-gray-400 border-1 estabElement mb-2" role="button" onclick="location.href='#<%=establecimiento.id%>'" hidden>
      <div class="d-flex align-items-center"><img src="data:image/png;base64,<%=establecimiento.photo[0]%>" style="width: 140px"></div>
      <div class="px-2 py-1">
        <p hidden><%=establecimiento.latitude%></p>
        <p hidden><%=establecimiento.longitude%></p>
        <h6 class="py-1 m-0"><%=establecimiento.name%></h6>
        <p class="my-1 text-danger"><%=establecimiento.type%></p>
        <p class="my-1"><%=establecimiento.location.address%>, <%=establecimiento.location.district%>, <%=establecimiento.location.province%></p>
        <div class="d-flex"><p class="my-1">Valoraci√≥n: <%=establecimiento.rating%>/5 <img style="width: 18px; height: 18px" src="https://img.icons8.com/ios-glyphs/30/000000/dog-footprint.png" /></p> </div>
      </div>
    </div>
    <% }) %>
  </div>
</div>

<style>
    #map {
      height: 50rem;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
</style>

<script>
    let markers = [];
    var lats = [];
    var longs = [];

    async function showEstabElements(){
      var allEstab = document.getElementsByClassName("estabElement")
      Array.from(allEstab).forEach((est) => {
        if(lats.length==0) {
          est.hidden = true
          est.classList.remove("d-flex")
        }
        else {
          var lat = parseFloat(est.getElementsByTagName("div")[1].getElementsByTagName('p')[0].textContent)
          var lon = parseFloat(est.getElementsByTagName("div")[1].getElementsByTagName('p')[1].textContent)
          for (let i = 0; i < lats.length; i++) {
            if (lat === lats[i] && lon === longs[i]) {
              est.hidden = false
              est.classList.add("d-flex")
              break
            }
            else {
              est.hidden = true
              est.classList.remove("d-flex")
            }
          }
        }
      });
    }

    const onBoundsChange = (event) =>{
      lats = []
      longs = []
      let bounds = map.getBounds()
      markers.forEach(m => {
        if (bounds.contains(m.getPosition())) {
          lats.push(parseFloat(m.getPosition().lat()))
          longs.push(parseFloat(m.getPosition().lng()))
        }
      }) 
      try {
        google.maps.event.removeListener(zoomChangeBoundsListener);
      } catch (error) {}     
      showEstabElements()
    }

    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl)
    })


    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -12.060459, lng: -77.040270 },
          zoom: 16,
      });

      //Adding rightclick event listener here
      google.maps.event.addListener(map, "rightclick", function(event) {
        var lat = event.latLng.lat();
        var long = event.latLng.lng();
        // populate yor box/field with lat, lng
        document.getElementById('longitud').title = long;
        document.getElementById('longitud').innerHTML  = "longitud: "+long;
        document.getElementById('latitud').title  = lat;
        document.getElementById('latitud').innerHTML  = "latitud: "+lat;
        document.getElementById('direccion').title  = "";
        document.getElementById('direccion').innerHTML  = "direccion: null";
        addMarker(event.latLng);
        window.setTimeout(function() {
          document.getElementById("btnAgregar").click(); 
        },500);
        //alert("Lat=" + lat + "; Lng=" + lng);
      });

      const locations = [
        {lat: -12.083750075956283, lng: -76.97704255222924},
        {lat: -12.078668590551107, lng: -77.00215935214327},
        {lat: -12.121898075505575, lng: -77.03064550074568}
      ]

      locations.forEach(location => {
        addMarker(location);
      })
      if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        map.panTo(initialLocation);
      });
    }
    google.maps.event.addListener(map, 'zoom_changed', function(event){
      zoomChangeBoundsListener = google.maps.event.addListener(map, 'bounds_changed', onBoundsChange)
    })
    google.maps.event.addListener(map, 'dragend', onBoundsChange)
    showEstabElements()
  }

  function addMarker(position) {
    const marker = new google.maps.Marker({
      position,
      map,
    });
    markers.push(marker);
  }
  async function deleteMarker() {
    showMarkers();
    markers.pop();
  }
  async function setMapOnAll(map) {
    for (let i = 0; i < markers.length; i++) {
      markers[i].setMap(map);
  }
  async function showMarkers() {
    setMapOnAll(map);
  }
  async function hideMarkers() {
    setMapOnAll(null);
  }
}
</script>

<div class="modal" id="modalAgregar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Establecimiento Petfriendly</h5>
      </div>
      <div class="modal-body" id="deleteMessage">
        <div id="longitud" title="" >longitud: </div>
        <div id="latitud" title="" >latitud: </div>
        <div id="direccion">direccion: </div>
        
        <button type="button" class="btn btn-warning" data-bs-toggle="popover" title="Coordenadas"
        data-bs-content="Longitud: xx.xxxx Latitud: yy.yyyy">Click</button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" onclick=CancelarClicked()>Cancelar</button>
        <button type="button" class="btn btn-success" onclick=AgregarClicked() >Agregar</button>
      </div>
    </div>
  </div>
</div>

<script>
  new bootstrap.Modal(document.getElementById('modalAgregar'), {backdrop: 'static', keyboard: false})
  function AgregarClicked(){
    const longCurrent = document.getElementById('longitud').title
    const latCurrent = document.getElementById('latitud').title
    location.href='establishments/new?lat='+latCurrent+'&?long='+longCurrent
  }
  function CancelarClicked(){
    setMapOnAll(null);
    markers.pop();
    setMapOnAll(map);
  }
</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCizeC9tFV647keWnjuTGF2G3yJregpyEs&callback=initMap">
</script>

